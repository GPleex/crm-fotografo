{% extends 'layout.html' %}

{% block conteudo %}
<h2 class="mb-4">Editar Cláusulas Personalizadas</h2>

<div class="mb-3 d-flex justify-content-end gap-2">
  <button type="button" class="btn btn-outline-primary btn-sm" onclick="expandirTudo()">Expandir tudo</button>
  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="colapsarTudo()">Colapsar tudo</button>
</div>

<form method="POST">
  {% for numero, texto in clausulas.items() %}
    {% set numero_id = numero.replace('ª', '').replace('º', '') %}
    {% set personalizado = (
        contrato.clausulas_personalizadas
        | selectattr('clausula_numero', 'equalto', numero)
        | map(attribute='conteudo') | list | first) %}
    {% set conteudo = personalizado if personalizado else texto %}

    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><strong>{{ numero }}:</strong> {{ texto[:60] | striptags }}...</span>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleEditor('{{ numero_id }}')">Editar</button>
      </div>
      <div class="card-body d-none" id="editor_{{ numero_id }}">
        <input type="hidden" id="clausula_{{ numero_id }}_input" name="clausula_{{ numero }}">
        <trix-editor input="clausula_{{ numero_id }}_input" class="form-control"></trix-editor>
      </div>
    </div>
  {% endfor %}

  <div class="mt-4">
    <button type="submit" class="btn btn-success">Salvar alterações</button>
    <a href="{{ url_for('visualizar_contrato', id=contrato.id) }}" class="btn btn-secondary">Cancelar</a>
  </div>
</form>

{% endblock %}

{% block scripts %}
<script>
  function toggleEditor(numero) {
    const editor = document.getElementById("editor_" + numero);
    if (editor) {
      editor.classList.toggle("d-none");
    }
  }

  function expandirTudo() {
    {% for numero in clausulas.keys() %}
      const ed_{{ loop.index }} = document.getElementById("editor_{{ numero.replace('ª', '').replace('º', '') }}");
      if (ed_{{ loop.index }}) ed_{{ loop.index }}.classList.remove("d-none");
    {% endfor %}
  }

  function colapsarTudo() {
    {% for numero in clausulas.keys() %}
      const ed_{{ loop.index }} = document.getElementById("editor_{{ numero.replace('ª', '').replace('º', '') }}");
      if (ed_{{ loop.index }}) ed_{{ loop.index }}.classList.add("d-none");
    {% endfor %}
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Coleta os dados em um array JavaScript
    const clausulasData = [
      {% for numero, texto in clausulas.items() %}
        {% set numero_id = numero.replace('ª', '').replace('º', '') %}
        {% set personalizado = (
            contrato.clausulas_personalizadas
            | selectattr('clausula_numero', 'equalto', numero)
            | map(attribute='conteudo') | list | first) %}
        {% set conteudo = personalizado if personalizado else texto %}
        {
          numero_id: "{{ numero_id }}",
          conteudo: {{ conteudo | tojson | safe }}
        }{% if not loop.last %},{% endif %}
      {% endfor %}
    ];

    // Itera sobre o array para definir os valores
    clausulasData.forEach(function(item) {
      const input = document.getElementById("clausula_" + item.numero_id + "_input");
      if (input) {
        input.value = item.conteudo;
      }
    });

    {% for c in contrato.clausulas_personalizadas %}
      const el = document.getElementById("editor_{{ c.clausula_numero.replace('ª', '').replace('º', '') }}");
      if (el) el.classList.remove("d-none");
    {% endfor %}
  });
</script>
{% endblock %}