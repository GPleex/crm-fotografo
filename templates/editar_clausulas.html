{% extends 'layout.html' %}
{% block conteudo %}
<h2 class="mb-4">Editar Cláusulas Personalizadas</h2>

<div class="mb-3 d-flex justify-content-end gap-2">
  <button type="button" class="btn btn-outline-primary btn-sm" onclick="expandirTudo()">Expandir tudo</button>
  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="colapsarTudo()">Colapsar tudo</button>
</div>

<form method="POST">
  {% for numero, texto in clausulas.items() %}
    {% set numero_id = numero.replace('ª', '').replace('º', '') %}
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><strong>Cláusula {{ numero }}:</strong> {{ texto[:60]|striptags }}...</span>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleEditor('{{ numero_id }}')">Editar</button>
      </div>
      <div class="card-body" id="editor_{{ numero_id }}" hidden>
        <input type="hidden" id="clausula_{{ numero_id }}_input" name="clausula_{{ numero }}">
        <div id="trix_wrapper_{{ numero_id }}"></div>
      </div>
    </div>
  {% endfor %}

  <div class="mt-4">
    <button type="submit" class="btn btn-success">Salvar alterações</button>
    <a href="{{ url_for('visualizar_contrato', id=contrato.id) }}" class="btn btn-secondary">Cancelar</a>
  </div>
</form>

<!-- Trix Editor -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/trix/2.0.0/trix.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/trix/2.0.0/trix.min.js"></script>

<script>
  function toggleEditor(numero) {
    const editor = document.getElementById("editor_" + numero);
    if (editor) editor.hidden = !editor.hidden;
  }

  function expandirTudo() {
    {% for numero in clausulas.keys() %}
      const el = document.getElementById("editor_{{ numero.replace('ª', '').replace('º', '') }}");
      if (el) el.hidden = false;
    {% endfor %}
  }

  function colapsarTudo() {
    {% for numero in clausulas.keys() %}
      const el = document.getElementById("editor_{{ numero.replace('ª', '').replace('º', '') }}");
      if (el) el.hidden = true;
    {% endfor %}
  }

  document.addEventListener("DOMContentLoaded", function () {
    {% for numero, texto in clausulas.items() %}
      {% set numero_id = numero.replace('ª', '').replace('º', '') %}
      {% set personalizado = (contrato.clausulas_personalizadas
        | selectattr('clausula_numero', 'equalto', numero)
        | map(attribute='conteudo') | list | first) %}
      {% set conteudo = personalizado if personalizado else texto %}

      const input = document.getElementById("clausula_{{ numero_id }}_input");
      input.value = {{ conteudo | tojson | safe }};

      const wrapper = document.getElementById("trix_wrapper_{{ numero_id }}");
      const editor = document.createElement("trix-editor");
      editor.setAttribute("input", input.id);
      editor.className = "form-control";
      wrapper.appendChild(editor);
    {% endfor %}

    // Expandir cláusulas já personalizadas
    {% for c in contrato.clausulas_personalizadas %}
      const el = document.getElementById("editor_{{ c.clausula_numero.replace('ª', '').replace('º', '') }}");
      if (el) el.hidden = false;
    {% endfor %}
  });
</script>
{% endblock %}
