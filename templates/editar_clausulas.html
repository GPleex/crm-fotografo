{% extends 'layout.html' %}

{% block conteudo %}
<h2 class="mb-4">Editar Cláusulas Personalizadas</h2>

<form method="POST">
  {% for numero, texto in clausulas.items() %}
    {% set numero_id = numero.replace('ª', '').replace('º', '') %}
    {% set personalizado = (
      contrato.clausulas_personalizadas
      | selectattr('clausula_numero', 'equalto', numero)
      | map(attribute='conteudo') | list | first) %}
    {% set conteudo = personalizado if personalizado else texto %}

    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><strong>{{ numero }}:</strong> {{ texto[:60] | striptags }}...</span>
        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modal_{{ numero_id }}">
          Editar
        </button>
      </div>
      <input type="hidden" id="clausula_{{ numero_id }}_input" name="clausula_{{ numero }}">
    </div>

    <!-- Modal -->
    <div class="modal fade" id="modal_{{ numero_id }}" tabindex="-1" aria-labelledby="modalLabel_{{ numero_id }}" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalLabel_{{ numero_id }}">Editar Cláusula {{ numero }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="modal_input" name="modal_conteudo">
            <trix-editor input="modal_input"></trix-editor>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="salvarClausula('{{ numero_id }}')">Salvar</button>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}

  <div class="mt-4">
    <button type="submit" class="btn btn-success">Salvar alterações</button>
    <a href="{{ url_for('visualizar_contrato', id=contrato.id) }}" class="btn btn-secondary">Cancelar</a>
  </div>
</form>
{% endblock %}

{% block scripts %}
<!-- Trix Editor -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/trix/2.0.0/trix.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/trix/2.0.0/trix.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Preenche os valores iniciais nos modais e nos inputs escondidos
    const clausulasData = [
      {% for numero, texto in clausulas.items() %}
        {% set numero_id = numero.replace('ª', '').replace('º', '') %}
        {% set personalizado = (
          contrato.clausulas_personalizadas
          | selectattr('clausula_numero', 'equalto', numero)
          | map(attribute='conteudo') | list | first) %}
        {% set conteudo = personalizado if personalizado else texto %}
        {
          numero_id: "{{ numero_id }}",
          conteudo: {{ conteudo | tojson | safe }}
        }{% if not loop.last %},{% endif %}
      {% endfor %}
    ];

    clausulasData.forEach(function(item) {
      const modalInput = document.getElementById("modal_input_" + item.numero_id);
      const hiddenInput = document.getElementById("clausula_" + item.numero_id + "_input");
      if (modalInput && hiddenInput) {
        modalInput.value = item.conteudo;
        hiddenInput.value = item.conteudo;
      }
    });
  });

  // Salva o conteúdo do editor no input escondido
  function salvarClausula(numero_id) {
    const modalInput = document.getElementById("modal_input_" + numero_id);
    const hiddenInput = document.getElementById("clausula_" + numero_id + "_input");
    if (modalInput && hiddenInput) {
      hiddenInput.value = modalInput.value;
    }

    // Fecha o modal programaticamente
    const modal = bootstrap.Modal.getInstance(document.getElementById("modal_" + numero_id));
    modal.hide();
  }

  function abrirModal(numero, texto) {
    const modalInput = document.getElementById("modal_input");
    const titulo = document.getElementById("modalTitulo");

    // Título
    titulo.textContent = "Editar Cláusula " + numero;

    // Define conteúdo no campo hidden
    modalInput.value = texto;

    // Exibe o modal
    const modal = new bootstrap.Modal(document.getElementById("modalClausula"));
    modal.show();
  }

</script>
{% endblock %}
